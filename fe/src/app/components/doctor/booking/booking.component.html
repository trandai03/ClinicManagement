<main id="main" class="main">
  <div class="pagetitle" style="margin-top: 20px; margin-bottom: 20px">
    <h1>Quản lý lịch khám</h1>
  </div>
  <!-- End Page Title -->

  <!-- Navigation tabs -->
  <div class="booking-tabs-container">
    <ul class="nav nav-tabs" id="bookingTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button
          class="nav-link"
          [class.active]="activeTab === 'CONFIRMING'"
          id="confirming-tab"
          data-bs-toggle="tab"
          data-bs-target="#confirming"
          type="button"
          role="tab"
          (click)="switchTab('CONFIRMING')"
        >
          <i class="fas fa-clock"></i>
          Chờ xác nhận
          <span class="badge bg-warning ms-2" *ngIf="confirmingCount > 0">{{
            confirmingCount
          }}</span>
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button
          class="nav-link"
          [class.active]="activeTab === 'ACCEPTING'"
          id="accepting-tab"
          data-bs-toggle="tab"
          data-bs-target="#accepting"
          type="button"
          role="tab"
          (click)="switchTab('ACCEPTING')"
        >
          <i class="fas fa-check-circle"></i>
          Đã xác nhận
          <span class="badge bg-success ms-2" *ngIf="acceptingCount > 0">{{
            acceptingCount
          }}</span>
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button
          class="nav-link"
          [class.active]="activeTab === 'IN_PROGRESS'"
          id="in-progress-tab"
          data-bs-toggle="tab"
          data-bs-target="#in-progress"
          type="button"
          role="tab"
          (click)="switchTab('IN_PROGRESS')"
        >
          <i class="fas fa-stethoscope"></i>
          Đang khám
          <span class="badge bg-info ms-2" *ngIf="inProgressCount > 0">{{
            inProgressCount
          }}</span>
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button
          class="nav-link"
          [class.active]="activeTab === 'AWAITING_RESULTS'"
          id="awaiting-results-tab"
          data-bs-toggle="tab"
          data-bs-target="#awaiting-results"
          type="button"
          role="tab"
          (click)="switchTab('AWAITING_RESULTS')"
        >
          <i class="fas fa-flask"></i>
          Chờ kết quả XN
          <span
            class="badge bg-primary ms-2"
            *ngIf="awaitingResultsCount > 0"
            >{{ awaitingResultsCount }}</span
          >
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button
          class="nav-link"
          [class.active]="activeTab === 'SUCCESS'"
          id="success-tab"
          data-bs-toggle="tab"
          data-bs-target="#success"
          type="button"
          role="tab"
          (click)="switchTab('SUCCESS')"
        >
          <i class="fas fa-check-double"></i>
          Hoàn thành
          <span class="badge bg-dark ms-2" *ngIf="successCount > 0">{{
            successCount
          }}</span>
        </button>
      </li>
    </ul>
  </div>

  <section class="section">
    <div class="row">
      <div class="col-lg-12">
        <div class="card">
          <div class="card-body" style="margin-top: 20px">
            <!-- Tab Content -->
            <div class="tab-content" id="bookingTabsContent">
              <!-- Chờ xác nhận Tab -->
              <div
                class="tab-pane fade"
                [class.show]="activeTab === 'CONFIRMING'"
                [class.active]="activeTab === 'CONFIRMING'"
                id="confirming"
                role="tabpanel"
              >
                <ng-container
                  [ngTemplateOutlet]="confirmingTemplate"
                ></ng-container>
              </div>

              <!-- Đã xác nhận Tab -->
              <div
                class="tab-pane fade"
                [class.show]="activeTab === 'ACCEPTING'"
                [class.active]="activeTab === 'ACCEPTING'"
                id="accepting"
                role="tabpanel"
              >
                <ng-container
                  [ngTemplateOutlet]="acceptingTemplate"
                ></ng-container>
              </div>

              <!-- Đang khám Tab -->
              <div
                class="tab-pane fade"
                [class.show]="activeTab === 'IN_PROGRESS'"
                [class.active]="activeTab === 'IN_PROGRESS'"
                id="in-progress"
                role="tabpanel"
              >
                <ng-container
                  [ngTemplateOutlet]="inProgressTemplate"
                ></ng-container>
              </div>

              <!-- Chờ kết quả XN Tab -->
              <div
                class="tab-pane fade"
                [class.show]="activeTab === 'AWAITING_RESULTS'"
                [class.active]="activeTab === 'AWAITING_RESULTS'"
                id="awaiting-results"
                role="tabpanel"
              >
                <ng-container
                  [ngTemplateOutlet]="awaitingResultsTemplate"
                ></ng-container>
              </div>

              <!-- Hoàn thành Tab -->
              <div
                class="tab-pane fade"
                [class.show]="activeTab === 'SUCCESS'"
                [class.active]="activeTab === 'SUCCESS'"
                id="success"
                role="tabpanel"
              >
                <ng-container
                  [ngTemplateOutlet]="successTemplate"
                ></ng-container>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
</main>
<!-- End #main -->

<!-- // Day la modal xem thonng tin chi tiet chuyen ngành-->
<div class="card">
  <div class="card-body" style="padding: 0px">
    <!-- <div class="modal fade" id="basicModal">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h2 class="modal-title">Thêm bài mới</h2>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <form class="row g-3">
                <div class="col-md-12">
                  <label for="inputName5" class="form-label">Tiêu đề</label>
                  <input type="text" class="form-control" id="inputName5" />
                </div>
                <div class="col-md-12">
                  <label for="inputEmail5" class="form-label">Nội dung</label>
                  <textarea class="form-control" id="inputEmail5" style="height: 120px"></textarea>
                </div>
                <div class="col-md-6">
                  <label for="inputPassword5" class="form-label">Hình ảnh</label>
                  <input type="file" class="form-control" id="inputPassword5" />
                </div>
                <div class="col-12">
                  <label>Preview image:</label> &nbsp;&nbsp;
                  <img src="https://tamanhhospital.vn/wp-content/uploads/2020/11/icon-tieuhoa.png" alt=""
                    style="height: 100px; width: 100px" />
                </div>
              </form>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                Close
              </button>
              <button type="button" class="btn btn-primary">
                Save changes
              </button>
            </div>
          </div>
        </div>
      </div> -->
    <!-- End Basic Modal-->
    <div class="modal fade" id="basicModalxem">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h2 class="modal-title">Thông tin chi tiết lịch hẹn</h2>
          </div>
          <div class="modal-body">
            <!-- Multi Columns Form -->
            <form class="row g-3">
              <div class="col-md-12">
                <label for="inputName5" class="form-label">Tên bệnh nhân</label>
                <input
                  [value]="itemout.name"
                  type="text"
                  class="form-control"
                  id="inputName5"
                  readonly
                />
              </div>
              <div class="col-md-12">
                <label for="inputName5" class="form-label">Ngày sinh</label>
                <input
                  [value]="itemout.dob"
                  type="text"
                  class="form-control"
                  id="inputName5"
                  readonly
                />
              </div>
              <div class="col-md-12">
                <label for="inputEmail5" class="form-label">Ghi chú</label>
                <textarea
                  [value]="itemout.note"
                  class="form-control"
                  id="inputEmail5"
                  style="height: 120px"
                  readonly
                ></textarea>
              </div>
              <div class="col-md-12">
                <label for="inputName55" class="form-label">Ngày đăng</label>
                <input
                  [value]="itemout.date"
                  type="text"
                  class="form-control"
                  id="inputName55"
                  readonly
                />
              </div>
            </form>
            <!-- End Multi Columns Form -->
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Close
            </button>
            <!-- <button type="button" class="btn btn-primary">Save changes</button> -->
          </div>
        </div>
      </div>
    </div>
    <!-- End Basic Modal-->
    <div class="modal fade" id="basicModalsua" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h2 class="modal-title">
              Thêm lịch hẹn có id: {{ itemout.id }} vào thời khóa biểu
            </h2>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">Ngày khám : {{ itemout.date }}</div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Hủy
            </button>
            <button
              type="button"
              class="btn btn-primary"
              data-bs-dismiss="modal"
              (click)="xacnhan(itemout.id)"
            >
              Đồng ý
            </button>
          </div>
        </div>
      </div>
    </div>
    <!-- End Basic Modal-->
    <div class="modal fade" id="basicModalxoa" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h2 class="modal-title">
              Bạn có chắc chắn hủy lịch hẹn có id: {{ itemout.id }}
            </h2>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">Ngày khám : {{ itemout.date }}</div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Quay lại
            </button>
            <button
              type="button"
              class="btn btn-primary"
              data-bs-dismiss="modal"
              (click)="huy(itemout.id)"
            >
              Đồng ý
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<ng-template #loading>
  <div
    class="spinner-border"
    style="width: 100px; height: 100px; margin-left: 48%"
    role="status"
  >
    <span class="visually-hidden">Loading...</span>
  </div>
</ng-template>

<ng-template #loaded>
  <!-- Table with hoverable rows -->
  <table
    datatable
    [dtOptions]="dtOption"
    [dtTrigger]="dtTrigger"
    class="table table-hover"
  >
    <thead>
      <tr>
        <th style="text-align: center">Id</th>
        <th style="text-align: center">Tên bệnh nhân</th>
        <th style="text-align: center">Ngày sinh</th>
        <th style="text-align: center">Giới tính</th>
        <th style="text-align: center">Ngày khám</th>
        <th style="text-align: center">Khung giờ</th>
        <th style="text-align: center">Trạng thái</th>
        <th style="text-align: center">Hành động</th>
      </tr>
    </thead>
    <tbody class="text-center">
      <tr *ngFor="let item of lbooking; let i = index">
        <th>{{ item.id }}</th>
        <td>{{ item.name }}</td>
        <td>{{ item.dob }}</td>
        <td>{{ item.gender }}</td>
        <td>{{ item.date }}</td>
        <td>{{ hours[item.idHour - 1] }}</td>
        <td>Chờ xác nhận</td>
        <td>
          <button
            type="button"
            class="btn btn-primary rounded-pill"
            data-bs-toggle="modal"
            data-bs-target="#basicModalxem"
            (click)="xem(item)"
          >
            <i class="bi bi-eye"></i></button
          >&nbsp;&nbsp;
          <button
            type="button"
            class="btn btn-success rounded-pill"
            data-bs-toggle="modal"
            (click)="xem(item)"
            data-bs-target="#basicModalsua"
          >
            <i class="bi bi-check-lg"></i></button
          >&nbsp;&nbsp;
          <button
            type="button"
            class="btn btn-danger rounded-pill"
            data-bs-toggle="modal"
            (click)="xem(item)"
            data-bs-target="#basicModalxoa"
          >
            <i class="bi bi-trash3"></i>
          </button>
        </td>
      </tr>
    </tbody>
  </table>
  <!-- End Table with hoverable rows -->
  <!-- <div class="card">
        <div class="card-body"> -->
  <!-- <nav aria-label="Page navigation example">
      <ul class="pagination" style="justify-content: center; margin-top: 20px">
        <li class="page-item">
          <a class="page-link" href="#">Previous</a>
        </li>
        <li class="page-item"><a class="page-link" href="#">1</a></li>
        <li class="page-item"><a class="page-link" href="#">2</a></li>
        <li class="page-item"><a class="page-link" href="#">3</a></li>
        <li class="page-item">
          <a class="page-link" href="#">Next</a>
        </li>
      </ul>
    </nav> -->
  <!-- End Basic Pagination -->
</ng-template>

<!-- Template for CONFIRMING bookings -->
<ng-template #confirmingTemplate>
  <table
    datatable
    [dtOptions]="dtOption"
    [dtTrigger]="dtTrigger"
    class="table table-hover"
  >
    <thead>
      <tr>
        <th style="text-align: center">Id</th>
        <th style="text-align: center">Tên bệnh nhân</th>
        <th style="text-align: center">Ngày sinh</th>
        <th style="text-align: center">Giới tính</th>
        <th style="text-align: center">Ngày khám</th>
        <th style="text-align: center">Khung giờ</th>
        <th style="text-align: center">Trạng thái</th>
        <th style="text-align: center">Hành động</th>
      </tr>
    </thead>
    <tbody class="text-center">
      <tr *ngFor="let item of currentBookings; let i = index">
        <th>{{ item.id }}</th>
        <td>{{ item.name }}</td>
        <td>{{ item.dob }}</td>
        <td>{{ item.gender === "MALE" ? "Nam" : "Nữ" }}</td>
        <td>{{ item.date }}</td>
        <td>{{ hours[item.idHour - 1] }}</td>
        <td><span class="badge bg-warning">Chờ xác nhận</span></td>
        <td>
          <button
            type="button"
            class="btn btn-primary rounded-pill"
            data-bs-toggle="modal"
            data-bs-target="#basicModalxem"
            (click)="xem(item)"
          >
            <i class="bi bi-eye"></i></button
          >&nbsp;&nbsp;
          <button
            type="button"
            class="btn btn-success rounded-pill"
            data-bs-toggle="modal"
            (click)="xem(item)"
            data-bs-target="#basicModalsua"
          >
            <i class="bi bi-check-lg"></i></button
          >&nbsp;&nbsp;
          <button
            type="button"
            class="btn btn-danger rounded-pill"
            data-bs-toggle="modal"
            (click)="xem(item)"
            data-bs-target="#basicModalxoa"
          >
            <i class="bi bi-trash3"></i>
          </button>
        </td>
      </tr>
    </tbody>
  </table>
</ng-template>

<!-- Template for ACCEPTING bookings -->
<ng-template #acceptingTemplate>
  <table class="table table-hover">
    <thead>
      <tr>
        <th style="text-align: center">Id</th>
        <th style="text-align: center">Tên bệnh nhân</th>
        <th style="text-align: center">Ngày sinh</th>
        <th style="text-align: center">Giới tính</th>
        <th style="text-align: center">Ngày khám</th>
        <th style="text-align: center">Khung giờ</th>
        <th style="text-align: center">Trạng thái</th>
        <th style="text-align: center">Hành động</th>
      </tr>
    </thead>
    <tbody class="text-center">
      <tr *ngFor="let item of currentBookings; let i = index">
        <th>{{ item.id }}</th>
        <td>{{ item.name }}</td>
        <td>{{ item.dob }}</td>
        <td>{{ item.gender === "MALE" ? "Nam" : "Nữ" }}</td>
        <td>{{ item.date }}</td>
        <td>{{ hours[item.idHour - 1] }}</td>
        <td><span class="badge bg-success">Đã xác nhận</span></td>
        <td>
          <button
            type="button"
            class="btn btn-primary rounded-pill"
            data-bs-toggle="modal"
            data-bs-target="#basicModalxem"
            (click)="xem(item)"
          >
            <i class="bi bi-eye"></i></button
          >&nbsp;&nbsp;
          <button
            type="button"
            class="btn btn-info rounded-pill"
            (click)="startExamination(item.id)"
          >
            <i class="fas fa-stethoscope"></i>
          </button>
        </td>
      </tr>
    </tbody>
  </table>
</ng-template>

<!-- Template for IN_PROGRESS bookings -->
<ng-template #inProgressTemplate>
  <div class="in-progress-container">
    <div class="row" *ngIf="currentBookings.length === 0">
      <div class="col-12 text-center">
        <div class="empty-state">
          <i class="fas fa-stethoscope fa-3x text-muted mb-3"></i>
          <h4>Không có bệnh nhân nào đang khám</h4>
          <p class="text-muted">
            Chọn "Bắt đầu khám" từ tab "Đã xác nhận" để bắt đầu khám bệnh
          </p>
        </div>
      </div>
    </div>

    <div class="row" *ngIf="currentBookings.length > 0">
      <div class="col-lg-6 col-xl-4 mb-3" *ngFor="let item of currentBookings">
        <div class="card booking-card h-100">
          <div class="card-header bg-info text-white">
            <h5 class="card-title mb-0">
              <i class="fas fa-user"></i> {{ item.name }}
            </h5>
            <small
              >BN: {{ item.id }} |
              {{ item.gender === "MALE" ? "Nam" : "Nữ" }}</small
            >
          </div>
          <div class="card-body">
            <p class="card-text">
              <i class="fas fa-calendar"></i> <strong>Ngày khám:</strong>
              {{ item.date }}<br />
              <i class="fas fa-clock"></i> <strong>Khung giờ:</strong>
              {{ hours[item.idHour - 1] }}<br />
              <i class="fas fa-stethoscope"></i> <strong>Chuyên khoa:</strong>
              {{ item.major || "Chưa xác định" }}
            </p>
            <span class="badge bg-info mb-2">Đang khám</span>
          </div>
          <div class="card-footer">
            <button
              class="btn btn-primary btn-sm me-2"
              (click)="continueExamination(item.id)"
            >
              <i class="fas fa-play"></i> Tiếp tục khám
            </button>
            <button
              type="button"
              class="btn btn-outline-primary btn-sm"
              data-bs-toggle="modal"
              data-bs-target="#basicModalxem"
              (click)="xem(item)"
            >
              <i class="bi bi-eye"></i> Chi tiết
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</ng-template>

<!-- Template for AWAITING_RESULTS bookings -->
<ng-template #awaitingResultsTemplate>
  <div class="awaiting-results-container">
    <div class="row" *ngIf="currentBookings.length === 0">
      <div class="col-12 text-center">
        <div class="empty-state">
          <i class="fas fa-flask fa-3x text-muted mb-3"></i>
          <h4>Không có bệnh nhân nào đang chờ kết quả</h4>
          <p class="text-muted">
            Bệnh nhân đang thực hiện xét nghiệm/dịch vụ sẽ xuất hiện ở đây
          </p>
        </div>
      </div>
    </div>

    <div class="row" *ngIf="currentBookings.length > 0">
      <div class="col-lg-6 col-xl-4 mb-3" *ngFor="let item of currentBookings">
        <div class="card booking-card h-100">
          <div class="card-header bg-primary text-white">
            <h5 class="card-title mb-0">
              <i class="fas fa-user"></i> {{ item.name }}
            </h5>
            <small
              >BN: {{ item.id }} |
              {{ item.gender === "MALE" ? "Nam" : "Nữ" }}</small
            >
          </div>
          <div class="card-body">
            <p class="card-text">
              <i class="fas fa-calendar"></i> <strong>Ngày khám:</strong>
              {{ item.date }}<br />
              <i class="fas fa-clock"></i> <strong>Khung giờ:</strong>
              {{ hours[item.idHour - 1] }}<br />
              <i class="fas fa-stethoscope"></i> <strong>Chuyên khoa:</strong>
              {{ item.major || "Chưa xác định" }}<br />
              <i class="fas fa-flask"></i> <strong>Trạng thái:</strong>
              <span class="text-primary">Chờ kết quả xét nghiệm</span>
            </p>
            <span class="badge bg-primary mb-2">Chờ kết quả XN</span>
          </div>
          <div class="card-footer">
            <button
              class="btn btn-success btn-sm me-2"
              (click)="continueAfterResults(item.id)"
            >
              <i class="fas fa-check"></i> Có kết quả, tiếp tục khám
            </button>
            <button
              type="button"
              class="btn btn-outline-primary btn-sm"
              data-bs-toggle="modal"
              data-bs-target="#basicModalxem"
              (click)="xem(item)"
            >
              <i class="bi bi-eye"></i> Chi tiết
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</ng-template>

<!-- Template for SUCCESS bookings -->
<ng-template #successTemplate>
  <table class="table table-hover">
    <thead>
      <tr>
        <th style="text-align: center">Id</th>
        <th style="text-align: center">Tên bệnh nhân</th>
        <th style="text-align: center">Ngày sinh</th>
        <th style="text-align: center">Ngày khám</th>
        <th style="text-align: center">Khung giờ</th>
        <th style="text-align: center">Trạng thái</th>
        <th style="text-align: center">Hành động</th>
      </tr>
    </thead>
    <tbody class="text-center">
      <tr *ngFor="let item of currentBookings; let i = index">
        <th>{{ item.id }}</th>
        <td>{{ item.name }}</td>
        <td>{{ item.dob }}</td>
        <td>{{ item.date }}</td>
        <td>{{ hours[item.idHour - 1] }}</td>
        <td><span class="badge bg-dark">Hoàn thành</span></td>
        <td>
          <button
            type="button"
            class="btn btn-primary rounded-pill"
            data-bs-toggle="modal"
            data-bs-target="#basicModalxem"
            (click)="xem(item)"
          >
            <i class="bi bi-eye"></i></button
          >&nbsp;&nbsp;
          <button
            type="button"
            class="btn btn-info rounded-pill"
            (click)="viewHistory(item.id)"
          >
            <i class="fas fa-history"></i>
          </button>
        </td>
      </tr>
    </tbody>
  </table>
</ng-template>
